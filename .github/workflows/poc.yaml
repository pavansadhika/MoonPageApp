name: POC-Workflow
on: [push]
env:
   DOCKER_IMAGE_NAME: pavan9999/github-actions
   DOCKER_IMAGE_TAG: MoonPageApp
jobs:
  #Docker Image Push Into Docker Registry
  build: 
     needs: Build_Scan_Docker_Image
     runs-on: self-hosted
     steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: "11"
          distribution: adopt
          cache: maven
      - name: Build before create image
        run: mvn package -DforkMode=never
      #Build Docker image and Push into Docker Hub 
      - name: Docker-Image-Build 
        run: | 
          sudo docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          sudo docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .
          sudo docker push ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
          sudo docker rmi -f ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
		  echo "DOCKER_IMAGE_TAG=${{ github.run_number }}" >> $GITHUB_ENV
	  outputs:
	    DOCKER_IMAGE_TAG=${{ env.DOCKER_IMAGE_TAG }}  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Get env variables
      run: |
        echo "DOCKER_IMAGE_TAG=${{ needs.build.outputs.DOCKER_IMAGE_TAG }}"
        sed -i "s;imagename;DOCKER_IMAGE_NAME:${{ github.run_number }};g" kube.yaml
        cat kube.yaml 
